<div class="row g-3">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <div>
        <h3 class="mb-0">{{ langService.translate('dashboard.controlPanel') }}</h3>
        <p class="text-muted small mb-0">
          {{ langService.translate('dashboard.welcome') }},
          <span class="fw-bold text-dark">
            {{ getUserTitle() }} {{ authService.currentUser()?.firstName }}
          </span>
        </p>
      </div>
      <div class="d-flex gap-2">
        <button
          class="btn glass-morphism border-0 px-3 py-1 rounded-3 shadow-sm btn-sm"
          (click)="downloadDailyReport()"
        >
          <i class="bi bi-download me-1"></i> {{ langService.translate('dashboard.report') }}
        </button>
        <button class="btn btn-primary-premium shadow-sm btn-sm" (click)="goToNewAppointment()">
          <i class="bi bi-plus-lg me-1"></i> {{ langService.translate('dashboard.newAppointment') }}
        </button>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- VISTA PARA PERSONAL (ADMIN / DOCTOR) -->
  <!-- ======================== -->
  <ng-container *ngIf="!authService.hasRole(['PATIENT'])">
    <!-- Stats Cards Row 1 -->
    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.appointments') }}
            </p>
            <h5 class="mb-0">{{ stats().appointmentsToday }}</h5>
          </div>
          <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
            <i class="bi bi-calendar-check fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.totalPatients') }}
            </p>
            <h5 class="mb-0">{{ stats().totalPatients }}</h5>
          </div>
          <div class="bg-success bg-opacity-10 text-success p-2 rounded-3">
            <i class="bi bi-person-plus fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6" *ngIf="!authService.hasRole(['NURSE'])">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.income') }}
            </p>
            <h5 class="mb-0">${{ stats().monthlyIncome | number: '1.0-0' }}</h5>
          </div>
          <div class="bg-warning bg-opacity-10 text-warning p-2 rounded-3">
            <i class="bi bi-currency-dollar fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.pending') }}
            </p>
            <h5 class="mb-0">{{ stats().pendingAppointments }}</h5>
          </div>
          <div class="bg-info bg-opacity-10 text-info p-2 rounded-3">
            <i class="bi bi-clock-history fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.inPerson') }}
            </p>
            <h5 class="mb-0">{{ stats().inPersonCount }}</h5>
          </div>
          <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
            <i class="bi bi-person-workspace fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.videoCalls') }}
            </p>
            <h5 class="mb-0">{{ stats().videoCount }}</h5>
          </div>
          <div class="bg-info bg-opacity-10 text-info p-2 rounded-3">
            <i class="bi bi-camera-video fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Area -->
    <div class="col-md-8">
      <div class="card-premium h-100 p-3 border-0">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0 x-small fw-bold text-uppercase">
            {{ langService.translate('dashboard.activity') }}
          </h6>
          <select class="form-select border-0 bg-light w-auto x-small py-0">
            <option>{{ langService.translate('dashboard.days7') }}</option>
          </select>
        </div>
        <div class="chart-container" style="position: relative; height: 180px; width: 100%">
          <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="barChartType">
          </canvas>
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <div class="card-premium h-100 p-3 border-0">
        <h6 class="mb-3">{{ langService.translate('dashboard.upcoming') }}</h6>
        <div class="overflow-auto custom-scrollbar" style="max-height: 240px">
          <div class="d-grid gap-2">
            <!-- Admin View of Appointments -->
            <div
              *ngFor="let apt of stats().upcomingAppointments"
              class="d-flex align-items-center gap-2 p-2 rounded-3 bg-light bg-opacity-50"
            >
              <div
                class="avatar-circle bg-primary bg-opacity-10 text-primary fw-bold"
                style="
                  width: 32px;
                  height: 32px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 50%;
                  font-size: 0.8rem;
                "
              >
                {{ apt.patient.name.charAt(0) }}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0 x-small fw-bold">{{ apt.patient.name }}</h6>
                <p class="text-muted x-small mb-0">
                  {{ apt.doctor.specialty }} - {{ formatTime(apt.time) }}
                </p>
              </div>
              <button
                class="btn btn-sm btn-light rounded-circle shadow-sm p-1"
                style="
                  width: 24px;
                  height: 24px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
                [routerLink]="['/appointments']"
              >
                <i class="bi bi-chevron-right" style="font-size: 0.6rem"></i>
              </button>
            </div>
            <!-- Empty state -->
            <div *ngIf="stats().upcomingAppointments?.length === 0" class="text-center py-4">
              <i class="bi bi-calendar-x text-muted fs-4 mb-2"></i>
              <p class="text-muted x-small mb-0">
                {{ langService.translate('dashboard.noUpcoming') }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECCIÓN DE RENDIMIENTO POR ESPECIALIDAD -->
    <div class="col-md-5">
      <div class="card-premium p-3 border-0 h-100 text-center">
        <h6 class="fw-bold mb-2 x-small text-uppercase">
          <i class="bi bi-stethoscope text-primary me-1"></i>
          {{ langService.translate('dashboard.stats.specialtyBreakdown') }}
        </h6>
        <div class="chart-container" style="position: relative; height: 160px; width: 100%">
          <canvas baseChart [data]="pieChartData" [options]="pieChartOptions" [type]="pieChartType">
          </canvas>
        </div>
        <div
          *ngIf="stats().specialtyStats?.length === 0"
          class="text-center py-2 text-muted x-small"
        >
          No hay datos
        </div>
      </div>
    </div>

    <!-- SECCIÓN DE ANÁLISIS DE INGRESOS COMPACTA -->
    <div
      class="col-md-7"
      *ngIf="authService.hasRole(['SUPERADMIN', 'ADMINISTRATIVE', 'RECEPTIONIST', 'DOCTOR'])"
    >
      <div class="card-premium p-3 border-0 h-100">
        <h6 class="fw-bold mb-2 x-small text-uppercase d-flex align-items-center gap-2">
          <i class="bi bi-graph-up-arrow text-success"></i>
          {{ langService.translate('dashboard.stats.incomeAnalysis') }}
        </h6>

        <div class="row g-2 mt-0">
          <!-- DIARIO -->
          <div class="col-4">
            <div class="p-2 rounded-3 bg-light border-start border-4 border-primary">
              <span class="fw-bold x-small text-muted d-block">{{
                langService.translate('dashboard.stats.daily')
              }}</span>
              <div class="d-flex justify-content-between x-small mt-1 px-1">
                <span>USD</span
                ><span class="fw-bold">{{ stats().incomeDetails.day.USD | number: '1.0-0' }}</span>
              </div>
              <div class="d-flex justify-content-between x-small px-1">
                <span>Bs.</span
                ><span class="fw-bold text-success">{{
                  stats().incomeDetails.day.Bs | number: '1.0-0'
                }}</span>
              </div>
            </div>
          </div>
          <!-- SEMANAL -->
          <div class="col-4">
            <div class="p-2 rounded-3 bg-light border-start border-4 border-info">
              <span class="fw-bold x-small text-muted d-block">{{
                langService.translate('dashboard.stats.weekly')
              }}</span>
              <div class="d-flex justify-content-between x-small mt-1 px-1">
                <span>USD</span
                ><span class="fw-bold">{{ stats().incomeDetails.week.USD | number: '1.0-0' }}</span>
              </div>
              <div class="d-flex justify-content-between x-small px-1">
                <span>Bs.</span
                ><span class="fw-bold text-success">{{
                  stats().incomeDetails.week.Bs | number: '1.0-0'
                }}</span>
              </div>
            </div>
          </div>
          <!-- MENSUAL -->
          <div class="col-4">
            <div
              class="p-2 rounded-3 bg-primary bg-opacity-10 border-start border-4 border-primary-emphasis"
            >
              <span class="fw-bold x-small text-primary d-block">{{
                langService.translate('dashboard.stats.monthly')
              }}</span>
              <div class="d-flex justify-content-between x-small mt-1 px-1">
                <span>USD</span
                ><span class="fw-bold">{{
                  stats().incomeDetails.month.USD | number: '1.0-0'
                }}</span>
              </div>
              <div class="d-flex justify-content-between x-small px-1">
                <span>Bs.</span
                ><span class="fw-bold text-success">{{
                  stats().incomeDetails.month.Bs | number: '1.0-0'
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- ======================== -->
  <!-- VISTA PARA PACIENTE (SIMPLIFICADA) -->
  <!-- ======================== -->
  <ng-container *ngIf="authService.hasRole(['PATIENT'])">
    <div class="col-md-6">
      <div class="card-premium p-3 border-0 bg-primary bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-primary-emphasis x-small fw-bold text-uppercase mb-1">
              {{ langService.translate('dashboard.stats.inPerson') }}
            </p>
            <h3 class="mb-0 text-primary">{{ stats().inPersonCount }}</h3>
          </div>
          <div class="bg-primary bg-opacity-20 text-primary p-3 rounded-circle">
            <i class="bi bi-person-workspace fs-4"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card-premium p-3 border-0 bg-info bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-info-emphasis x-small fw-bold text-uppercase mb-1">
              {{ langService.translate('dashboard.stats.videoCalls') }}
            </p>
            <h3 class="mb-0 text-info">{{ stats().videoCount }}</h3>
          </div>
          <div class="bg-info bg-opacity-20 text-info p-3 rounded-circle">
            <i class="bi bi-camera-video fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card-premium h-100 p-4 border-0">
        <h5 class="mb-4 text-primary">{{ langService.translate('dashboard.medicalCitas') }}</h5>

        <div *ngIf="stats().upcomingAppointments?.length > 0; else noAppointments">
          <div class="d-grid gap-3">
            <div
              *ngFor="let apt of stats().upcomingAppointments"
              class="d-flex align-items-center gap-3 p-3 rounded-4 bg-white shadow-sm border"
            >
              <!-- Icono Doctor -->
              <div
                class="bg-primary bg-opacity-10 text-primary rounded-4 p-3 d-flex align-items-center justify-content-center"
                style="width: 60px; height: 60px"
              >
                <i class="bi bi-person-fill-add fs-3"></i>
              </div>

              <div class="flex-grow-1">
                <h6 class="mb-1 fw-bold text-dark">{{ apt.doctor.name }}</h6>
                <div class="d-flex flex-wrap gap-3 text-muted small">
                  <span
                    ><i class="bi bi-bandaid me-1 text-primary"></i>
                    {{ apt.doctor.specialty }}</span
                  >
                  <span
                    ><i class="bi bi-calendar-event me-1 text-primary"></i>
                    {{ apt.date | date: 'dd MMM yyyy' }}</span
                  >
                  <span
                    ><i class="bi bi-clock me-1 text-primary"></i> {{ formatTime(apt.time) }}</span
                  >
                </div>
              </div>

              <!-- Status Badge -->
              <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                {{ langService.translate('dashboard.confirmed') }}
              </span>
            </div>
          </div>
        </div>

        <ng-template #noAppointments>
          <div class="text-center py-5">
            <div class="bg-light rounded-circle p-4 d-inline-block mb-3">
              <i class="bi bi-calendar-heart text-muted fs-1"></i>
            </div>
            <h5>{{ langService.translate('dashboard.noUpcoming') }}</h5>
            <p class="text-muted mb-4">{{ langService.translate('dashboard.noUpcoming') }}</p>
            <button class="btn btn-primary-premium px-4" (click)="goToNewAppointment()">
              <i class="bi bi-plus-lg me-2"></i>
              {{ langService.translate('dashboard.newAppointment') }}
            </button>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Accesos Rápidos Paciente -->
    <div class="col-md-4">
      <div class="row g-4">
        <div class="col-12">
          <div
            class="card-premium p-4 border-0 bg-primary text-white"
            style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)"
          >
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="fw-bold mb-1">
                  {{ langService.translate('dashboard.newAppointment') }}
                </h4>
                <p class="text-white text-opacity-75 mb-3 small">
                  {{ langService.translate('dashboard.newAptDesc') }}
                </p>
                <button
                  class="btn btn-light text-primary fw-medium rounded-pill px-4 shadow-sm"
                  (click)="goToNewAppointment()"
                >
                  {{ langService.translate('dashboard.bookNow') }}
                </button>
              </div>
              <i class="bi bi-calendar-plus fs-1 text-white text-opacity-25"></i>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card-premium p-4 border-0">
            <h6 class="fw-bold mb-3">{{ langService.translate('dashboard.myResults') }}</h6>
            <div
              class="d-flex align-items-center justify-content-between p-3 rounded-3 bg-light cursor-pointer hover-scale transition"
              [routerLink]="['/lab-results']"
            >
              <div class="d-flex align-items-center gap-3">
                <div class="bg-warning bg-opacity-10 text-warning p-2 rounded-3">
                  <i class="bi bi-file-earmark-medical fs-5"></i>
                </div>
                <div>
                  <p class="mb-0 fw-bold small">{{ langService.translate('sidebar.lab') }}</p>
                  <p class="text-muted small mb-0">
                    {{ langService.translate('dashboard.recentExams') }}
                  </p>
                </div>
              </div>
              <i class="bi bi-chevron-right text-muted small"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- SECCIÓN DE RENDIMIENTO POR ESPECIALIDAD (PACIENTE) -->
    <div class="col-12 mt-4">
      <div class="card-premium p-4 border-0">
        <h6 class="fw-bold mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-stethoscope text-primary"></i>
          {{ langService.translate('dashboard.stats.specialtyBreakdown') }}
        </h6>
        <div class="row g-3">
          <div *ngFor="let s of stats().specialtyStats" class="col-md-3">
            <div class="p-3 rounded-4 bg-light border shadow-sm">
              <div class="small fw-bold text-dark mb-2">{{ s.name }}</div>
              <div class="d-flex justify-content-between x-small">
                <span class="text-muted">{{
                  langService.translate('dashboard.stats.toAttend')
                }}</span>
                <span class="fw-bold text-warning">{{ s.pending }}</span>
              </div>
              <div class="d-flex justify-content-between x-small mt-1">
                <span class="text-muted">{{
                  langService.translate('dashboard.stats.attended')
                }}</span>
                <span class="fw-bold text-success">{{ s.completed }}</span>
              </div>
            </div>
          </div>
          <div
            *ngIf="stats().specialtyStats?.length === 0"
            class="col-12 text-center py-3 text-muted x-small"
          >
            No hay datos de especialidades disponibles
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<style>
  .border-dashed {
    border: 2px dashed #e2e8f0;
  }
</style>
