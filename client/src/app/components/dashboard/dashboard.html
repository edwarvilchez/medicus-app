<div class="row g-2">
  <!-- TRIAL BANNER -->
  <div class="col-12" *ngIf="isTrialActive()">
    <div
      class="alert alert-warning border-0 shadow-sm d-flex justify-content-between align-items-center p-2 mb-2"
    >
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-hourglass-split fs-4 text-warning-emphasis"></i>
        <div>
          <h6 class="mb-0 fw-bold text-warning-emphasis">
            {{ getTrialDaysLeft() }} días restantes en tu prueba gratuita
          </h6>
          <p class="mb-0 x-small text-muted">Aprovecha al máximo todas las funciones premium.</p>
        </div>
      </div>
      <button class="btn btn-warning text-white btn-sm fw-bold shadow-sm" (click)="upgradePlan()">
        Actualizar Plan
      </button>
    </div>
  </div>

  <div class="col-12" *ngIf="isTrialExpired()">
    <div
      class="alert alert-danger border-0 shadow-sm d-flex justify-content-between align-items-center p-2 mb-2"
    >
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-exclamation-triangle-fill fs-4 text-danger"></i>
        <div>
          <h6 class="mb-0 fw-bold text-danger">Tu periodo de prueba ha finalizado</h6>
          <p class="mb-0 x-small text-muted">
            Para continuar usando Medicus, por favor actualiza tu plan.
          </p>
        </div>
      </div>
      <button class="btn btn-danger text-white btn-sm fw-bold shadow-sm" (click)="upgradePlan()">
        Actualizar Ahora
      </button>
    </div>
  </div>
  <!-- Header -->
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <div>
        <h5 class="mb-0">{{ langService.translate('dashboard.controlPanel') }}</h5>
        <p class="text-muted x-small mb-0">
          {{ langService.translate('dashboard.welcome') }},
          <span class="fw-bold text-dark">
            {{ getUserTitle() }} {{ authService.currentUser()?.firstName }}
          </span>
        </p>
      </div>
      <div class="d-flex gap-2">
        <button
          class="btn glass-morphism border-0 px-3 py-1 rounded-3 shadow-sm btn-sm"
          (click)="downloadDailyReport()"
        >
          <i class="bi bi-download me-1"></i> {{ langService.translate('dashboard.report') }}
        </button>
        <button class="btn btn-primary-premium shadow-sm btn-sm" (click)="goToNewAppointment()">
          <i class="bi bi-plus-lg me-1"></i> {{ langService.translate('dashboard.newAppointment') }}
        </button>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- VISTA PERSONAL (ADMIN / DOCTOR) -->
  <!-- ======================== -->
  <ng-container *ngIf="!authService.hasRole(['PATIENT'])">
    <!-- Stats Row — 6 cards -->
    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.appointments') }}
            </p>
            <h5 class="mb-0">{{ stats().appointmentsToday }}</h5>
          </div>
          <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
            <i class="bi bi-calendar-check fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.totalPatients') }}
            </p>
            <h5 class="mb-0">{{ stats().totalPatients }}</h5>
          </div>
          <div class="bg-success bg-opacity-10 text-success p-2 rounded-3">
            <i class="bi bi-person-plus fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6" *ngIf="!authService.hasRole(['NURSE'])">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.income') }}
            </p>
            <h5 class="mb-0">${{ stats().monthlyIncome | number: '1.0-0' }}</h5>
          </div>
          <div class="bg-warning bg-opacity-10 text-warning p-2 rounded-3">
            <i class="bi bi-currency-dollar fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.pending') }}
            </p>
            <h5 class="mb-0">{{ stats().pendingAppointments }}</h5>
          </div>
          <div class="bg-info bg-opacity-10 text-info p-2 rounded-3">
            <i class="bi bi-clock-history fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.inPerson') }}
            </p>
            <h5 class="mb-0">{{ stats().inPersonCount }}</h5>
          </div>
          <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
            <i class="bi bi-person-workspace fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-2 col-6">
      <div class="card-premium p-2 border-0 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted x-small fw-medium mb-0">
              {{ langService.translate('dashboard.stats.videoCalls') }}
            </p>
            <h5 class="mb-0">{{ stats().videoCount }}</h5>
          </div>
          <div class="bg-info bg-opacity-10 text-info p-2 rounded-3">
            <i class="bi bi-camera-video fs-6"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Activity chart (7) + Upcoming appointments (5) = 12 -->
    <div class="col-md-7">
      <div class="card-premium h-100 p-3 border-0">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h6 class="mb-0 x-small fw-bold text-uppercase">
            {{ langService.translate('dashboard.activity') }}
          </h6>
          <select class="form-select border-0 bg-light w-auto x-small py-0">
            <option>{{ langService.translate('dashboard.days7') }}</option>
          </select>
        </div>
        <div class="chart-container" style="position: relative; height: 150px; width: 100%">
          <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="barChartType">
          </canvas>
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <div class="card-premium h-100 p-3 border-0">
        <h6 class="mb-2 x-small fw-bold text-uppercase">
          {{ langService.translate('dashboard.upcoming') }}
        </h6>
        <div class="overflow-auto custom-scrollbar" style="max-height: 170px">
          <div class="d-grid gap-1">
            <div
              *ngFor="let apt of stats().upcomingAppointments"
              class="d-flex align-items-center gap-2 p-2 rounded-3 bg-light bg-opacity-50"
            >
              <div
                class="bg-primary bg-opacity-10 text-primary fw-bold d-flex align-items-center justify-content-center rounded-circle"
                style="width: 28px; height: 28px; font-size: 0.75rem; flex-shrink: 0"
              >
                {{ apt.patient.name.charAt(0) }}
              </div>
              <div class="flex-grow-1 min-width-0">
                <h6 class="mb-0 x-small fw-bold text-truncate">{{ apt.patient.name }}</h6>
                <p class="text-muted x-small mb-0 text-truncate">
                  {{ apt.doctor.specialty }} - {{ formatTime(apt.time) }}
                </p>
              </div>
              <button
                class="btn btn-sm btn-light rounded-circle shadow-sm p-0 d-flex align-items-center justify-content-center"
                style="width: 22px; height: 22px; flex-shrink: 0"
                [routerLink]="['/appointments']"
              >
                <i class="bi bi-chevron-right" style="font-size: 0.55rem"></i>
              </button>
            </div>
            <div *ngIf="stats().upcomingAppointments?.length === 0" class="text-center py-3">
              <i class="bi bi-calendar-x text-muted fs-5 mb-1"></i>
              <p class="text-muted x-small mb-0">
                {{ langService.translate('dashboard.noUpcoming') }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Specialty donut (4) + Income analysis (8) = 12 -->
    <div class="col-md-4">
      <div class="card-premium p-3 border-0 h-100 text-center">
        <h6 class="fw-bold mb-1 x-small text-uppercase">
          <i class="bi bi-stethoscope text-primary me-1"></i>
          {{ langService.translate('dashboard.stats.specialtyBreakdown') }}
        </h6>
        <div class="chart-container" style="position: relative; height: 140px; width: 100%">
          <canvas baseChart [data]="pieChartData" [options]="pieChartOptions" [type]="pieChartType">
          </canvas>
        </div>
        <div
          *ngIf="stats().specialtyStats?.length === 0"
          class="text-center py-2 text-muted x-small"
        >
          No hay datos
        </div>
      </div>
    </div>

    <div
      class="col-md-8"
      *ngIf="authService.hasRole(['SUPERADMIN', 'ADMINISTRATIVE', 'RECEPTIONIST', 'DOCTOR'])"
    >
      <div class="card-premium p-3 border-0 h-100">
        <h6 class="fw-bold mb-2 x-small text-uppercase d-flex align-items-center gap-2">
          <i class="bi bi-graph-up-arrow text-success"></i>
          {{ langService.translate('dashboard.stats.incomeAnalysis') }}
        </h6>

        <div class="row g-2 mt-0">
          <!-- DIARIO -->
          <div class="col-4">
            <div class="p-2 rounded-3 bg-light border-start border-4 border-primary">
              <span class="fw-bold x-small text-muted d-block">{{
                langService.translate('dashboard.stats.daily')
              }}</span>
              <div class="d-flex justify-content-between x-small mt-1 px-1">
                <span>USD</span
                ><span class="fw-bold">{{ stats().incomeDetails.day.USD | number: '1.0-0' }}</span>
              </div>
              <div class="d-flex justify-content-between x-small px-1">
                <span>Bs.</span
                ><span class="fw-bold text-success">{{
                  stats().incomeDetails.day.Bs | number: '1.0-0'
                }}</span>
              </div>
            </div>
          </div>
          <!-- SEMANAL -->
          <div class="col-4">
            <div class="p-2 rounded-3 bg-light border-start border-4 border-info">
              <span class="fw-bold x-small text-muted d-block">{{
                langService.translate('dashboard.stats.weekly')
              }}</span>
              <div class="d-flex justify-content-between x-small mt-1 px-1">
                <span>USD</span
                ><span class="fw-bold">{{ stats().incomeDetails.week.USD | number: '1.0-0' }}</span>
              </div>
              <div class="d-flex justify-content-between x-small px-1">
                <span>Bs.</span
                ><span class="fw-bold text-success">{{
                  stats().incomeDetails.week.Bs | number: '1.0-0'
                }}</span>
              </div>
            </div>
          </div>
          <!-- MENSUAL -->
          <div class="col-4">
            <div
              class="p-2 rounded-3 bg-primary bg-opacity-10 border-start border-4 border-primary-emphasis"
            >
              <span class="fw-bold x-small text-primary d-block">{{
                langService.translate('dashboard.stats.monthly')
              }}</span>
              <div class="d-flex justify-content-between x-small mt-1 px-1">
                <span>USD</span
                ><span class="fw-bold">{{
                  stats().incomeDetails.month.USD | number: '1.0-0'
                }}</span>
              </div>
              <div class="d-flex justify-content-between x-small px-1">
                <span>Bs.</span
                ><span class="fw-bold text-success">{{
                  stats().incomeDetails.month.Bs | number: '1.0-0'
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- ======================== -->
  <!-- VISTA PACIENTE -->
  <!-- ======================== -->
  <ng-container *ngIf="authService.hasRole(['PATIENT'])">
    <div class="col-md-6">
      <div class="card-premium p-3 border-0 bg-primary bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-primary-emphasis x-small fw-bold text-uppercase mb-1">
              {{ langService.translate('dashboard.stats.inPerson') }}
            </p>
            <h3 class="mb-0 text-primary">{{ stats().inPersonCount }}</h3>
          </div>
          <div class="bg-primary bg-opacity-20 text-primary p-3 rounded-circle">
            <i class="bi bi-person-workspace fs-4"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card-premium p-3 border-0 bg-info bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-info-emphasis x-small fw-bold text-uppercase mb-1">
              {{ langService.translate('dashboard.stats.videoCalls') }}
            </p>
            <h3 class="mb-0 text-info">{{ stats().videoCount }}</h3>
          </div>
          <div class="bg-info bg-opacity-20 text-info p-3 rounded-circle">
            <i class="bi bi-camera-video fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card-premium h-100 p-3 border-0">
        <h6 class="mb-2 text-primary fw-bold">
          {{ langService.translate('dashboard.medicalCitas') }}
        </h6>

        <div *ngIf="stats().upcomingAppointments?.length > 0; else noAppointments">
          <div class="d-grid gap-2 overflow-auto custom-scrollbar" style="max-height: 220px">
            <div
              *ngFor="let apt of stats().upcomingAppointments"
              class="d-flex align-items-center gap-2 p-2 rounded-3 bg-white shadow-sm border"
            >
              <div
                class="bg-primary bg-opacity-10 text-primary rounded-3 d-flex align-items-center justify-content-center"
                style="width: 40px; height: 40px; flex-shrink: 0"
              >
                <i class="bi bi-person-fill-add fs-5"></i>
              </div>

              <div class="flex-grow-1 min-width-0">
                <h6 class="mb-0 small fw-bold text-truncate">{{ apt.doctor.name }}</h6>
                <div class="d-flex flex-wrap gap-2 text-muted x-small">
                  <span
                    ><i class="bi bi-bandaid me-1 text-primary"></i>{{ apt.doctor.specialty }}</span
                  >
                  <span
                    ><i class="bi bi-calendar-event me-1 text-primary"></i
                    >{{ apt.date | date: 'dd MMM' }}</span
                  >
                  <span
                    ><i class="bi bi-clock me-1 text-primary"></i>{{ formatTime(apt.time) }}</span
                  >
                </div>
              </div>

              <span
                class="badge bg-success bg-opacity-10 text-success px-2 py-1 rounded-pill x-small"
              >
                {{ langService.translate('dashboard.confirmed') }}
              </span>
            </div>
          </div>
        </div>

        <ng-template #noAppointments>
          <div class="text-center py-4">
            <div class="bg-light rounded-circle p-3 d-inline-block mb-2">
              <i class="bi bi-calendar-heart text-muted fs-3"></i>
            </div>
            <p class="text-muted small mb-2">{{ langService.translate('dashboard.noUpcoming') }}</p>
            <button class="btn btn-primary-premium btn-sm px-3" (click)="goToNewAppointment()">
              <i class="bi bi-plus-lg me-1"></i>
              {{ langService.translate('dashboard.newAppointment') }}
            </button>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="col-md-4">
      <div class="d-grid gap-2">
        <div
          class="card-premium p-3 border-0 bg-primary text-white"
          style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)"
        >
          <h6 class="fw-bold mb-1">{{ langService.translate('dashboard.newAppointment') }}</h6>
          <p class="text-white text-opacity-75 mb-2 x-small">
            {{ langService.translate('dashboard.newAptDesc') }}
          </p>
          <button
            class="btn btn-light text-primary fw-medium rounded-pill px-3 btn-sm shadow-sm"
            (click)="goToNewAppointment()"
          >
            {{ langService.translate('dashboard.bookNow') }}
          </button>
        </div>

        <div class="card-premium p-3 border-0">
          <h6 class="fw-bold mb-2 small">{{ langService.translate('dashboard.myResults') }}</h6>
          <div
            class="d-flex align-items-center justify-content-between p-2 rounded-3 bg-light cursor-pointer"
            [routerLink]="['/lab-results']"
          >
            <div class="d-flex align-items-center gap-2">
              <div class="bg-warning bg-opacity-10 text-warning p-2 rounded-3">
                <i class="bi bi-file-earmark-medical fs-6"></i>
              </div>
              <div>
                <p class="mb-0 fw-bold x-small">{{ langService.translate('sidebar.lab') }}</p>
                <p class="text-muted x-small mb-0">
                  {{ langService.translate('dashboard.recentExams') }}
                </p>
              </div>
            </div>
            <i class="bi bi-chevron-right text-muted x-small"></i>
          </div>
        </div>

        <!-- Specialty mini cards -->
        <div class="card-premium p-3 border-0">
          <h6 class="fw-bold mb-2 x-small text-uppercase">
            <i class="bi bi-stethoscope text-primary me-1"></i>
            {{ langService.translate('dashboard.stats.specialtyBreakdown') }}
          </h6>
          <div class="d-grid gap-1">
            <div
              *ngFor="let s of stats().specialtyStats"
              class="d-flex justify-content-between align-items-center p-2 rounded-3 bg-light"
            >
              <span class="x-small fw-bold text-truncate">{{ s.name }}</span>
              <div class="d-flex gap-2">
                <span class="badge bg-warning bg-opacity-10 text-warning x-small">{{
                  s.pending
                }}</span>
                <span class="badge bg-success bg-opacity-10 text-success x-small">{{
                  s.completed
                }}</span>
              </div>
            </div>
            <div
              *ngIf="stats().specialtyStats?.length === 0"
              class="text-center py-2 text-muted x-small"
            >
              No hay datos
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>
