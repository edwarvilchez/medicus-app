name: Pipeline - Promotion Manager

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Target Environment to Promote To"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

permissions:
  contents: write

jobs:
  promote:
    name: Promote to ${{ github.event.inputs.target_env }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # --- STAGING PROMOTION ---
      - name: Promote Develop -> Staging
        if: github.event.inputs.target_env == 'staging'
        run: |
          echo "üöÄ Promoting Develop to Staging..."
          git checkout staging
          git merge origin/develop --no-ff -m "chore: promote develop to staging [modificado por antigravity]"
          git push origin staging
          echo "### ‚úÖ Promotion Result" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** develop" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Success" >> $GITHUB_STEP_SUMMARY

      # --- PRODUCTION PROMOTION ---
      - name: Promote Staging -> Master (Production)
        if: github.event.inputs.target_env == 'production'
        run: |
          echo "üöÄ Promoting Staging to Production (Master)..."
          git checkout master
          git merge origin/staging --no-ff -m "release: promote staging to production [modificado por antigravity]"

          # Auto-tagging
          VERSION="v1.0.$(date +'%Y%m%d%H%M')"
          echo "üè∑Ô∏è Tagging version: $VERSION"
          git tag -a $VERSION -m "Production Release $VERSION"

          git push origin master --tags

          echo "### üöÄ Production Release Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** master" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Tag:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Deployed & Tagged" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Easypanel Webhooks
        if: success()
        run: |
          echo "üì° Triggering Easypanel Webhooks..."

          # Determinar qu√© webhooks usar basado en el target_env
          if [ "${{ github.event.inputs.target_env }}" == "staging" ]; then
            WEBHOOK_API="${{ secrets.STAGING_API_WEBHOOK }}"
            WEBHOOK_FRONT="${{ secrets.STAGING_FRONTEND_WEBHOOK }}"
          else
            WEBHOOK_API="${{ secrets.EASYPANEL_API_WEBHOOK }}"
            WEBHOOK_FRONT="${{ secrets.EASYPANEL_FRONTEND_WEBHOOK }}"
          fi

          if [ -n "$WEBHOOK_API" ]; then
            echo "Triggering API..."
            curl -f -X POST "$WEBHOOK_API" || echo "‚ö†Ô∏è Webhook API failed"
          fi

          if [ -n "$WEBHOOK_FRONT" ]; then
            echo "Triggering Frontend..."
            curl -f -X POST "$WEBHOOK_FRONT" || echo "‚ö†Ô∏è Webhook Frontend failed"
          fi
