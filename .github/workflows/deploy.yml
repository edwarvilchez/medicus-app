name: Deploy to EasyPanel

on:
  push:
    branches:
      - master
      - staging

concurrency:
  group: deploy-medicus-global
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for staging window (30s)
        if: github.ref == 'refs/heads/staging'
        run: |
          echo "⏱️ Iniciando ventana de despliegue para Staging..."
          sleep 30

      - name: Wait for production window (180s)
        if: github.ref == 'refs/heads/master'
        run: |
          echo "⏱️ Iniciando ventana de seguridad de 3 minutos para Producción..."
          sleep 180

      - name: Deploy API
        if: env.API_WEBHOOK != ''
        run: |
          curl -f -X POST "${{ secrets.EASYPANEL_API_WEBHOOK }}"
        env:
          API_WEBHOOK: ${{ secrets.EASYPANEL_API_WEBHOOK }}

      - name: Check API Webhook Secret
        if: env.API_WEBHOOK == ''
        run: |
          echo "❌ Error: EASYPANEL_API_WEBHOOK no está configurado."
          exit 1
        env:
          API_WEBHOOK: ${{ secrets.EASYPANEL_API_WEBHOOK }}

      - name: Deploy Frontend
        if: (github.ref == 'refs/heads/master') && (env.FRONTEND_WEBHOOK != '')
        run: |
          curl -f -X POST "${{ secrets.EASYPANEL_FRONTEND_WEBHOOK }}"
        env:
          FRONTEND_WEBHOOK: ${{ secrets.EASYPANEL_FRONTEND_WEBHOOK }}
